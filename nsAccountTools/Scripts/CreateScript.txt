DROP VIEW IF EXISTS contabilizacao.vw_dadosusuarios_empresas;

CREATE OR REPLACE VIEW contabilizacao.vw_dadosusuarios_empresas AS
SELECT
	dd.dadousuario AS id,
	COALESCE(e.nome, dl.descricao) AS descricao_lancamento_rubrica,
	opp.descricao AS abertura,
	COALESCE(ops.descricao, 'CONTA FIXA') AS abertura_secundaria,
	dd.contadebito,
	dd.contacredito,
	dd.empresa AS empresa,
	o.objeto AS fato,
	o.descricao AS descricao_fato,
	dc.dicionariocapitulo AS capitulo,
	dc.descricao AS descrica_capitulo
FROM		contabilizacao.dadosusuarios AS dd
JOIN		contabilizacao.opcoes AS opp ON dd.opcao = opp.opcao
LEFT JOIN	contabilizacao.opcoes AS ops ON dd.opcaosecundaria = ops.opcao
LEFT JOIN	contabilizacao.lancamentosfatos AS lf ON lf.lancamentofato = dd.lancamentofato
LEFT JOIN	contabilizacao.dicionariolancamentos AS dl ON lf.dicionariolancamento = dl.dicionariolancamento
LEFT JOIN	contabilizacao.contabilizacaorubricas AS cr ON dd.contabilizacaorubrica = cr.contabilizacaorubrica
LEFT JOIN	persona.eventos AS e ON cr.rubrica = e.evento
LEFT JOIN	contabilizacao.dicionariocapitulos AS dc ON
	CASE WHEN dd.contabilizacaorubrica IS NOT NULL THEN
		cr.dicionariocapitulo = dc.dicionariocapitulo
	ELSE
		dl.dicionariocapitulo = dc.dicionariocapitulo
	END
LEFT JOIN	contabilizacao.objetodicionariocapitulos AS odc ON odc.dicionariocapitulo = dc.dicionariocapitulo
LEFT JOIN	contabilizacao.objetos AS o ON o.objeto = odc.objeto;

DROP VIEW IF EXISTS contabilizacao.vw_objetoscapitulos_descricao;

CREATE OR REPLACE VIEW contabilizacao.vw_objetoscapitulos_descricao AS
SELECT
	o.objeto AS fato,
	dc.dicionariocapitulo AS capitulo,
	dc.descricao AS descricao
FROM		contabilizacao.objetos AS o
JOIN		contabilizacao.objetodicionariocapitulos AS odc ON o.objeto = odc.objeto
JOIN		contabilizacao.dicionariocapitulos AS dc ON odc.dicionariocapitulo = dc.dicionariocapitulo
ORDER BY	o.descricao, dc.descricao;

DROP VIEW IF EXISTS contabilizacao.vw_lancamentosfatos_capitulo_empresa;

CREATE OR REPLACE VIEW contabilizacao.vw_lancamentosfatos_capitulo_empresa AS
SELECT
	lf.lancamentofato,
	dl.dicionariocapitulo AS capitulo,
	f.empresa
FROM	contabilizacao.lancamentosfatos lf
JOIN	contabilizacao.fatos f ON lf.fato = f.fato
JOIN	contabilizacao.dicionariolancamentos dl ON lf.dicionariolancamento = dl.dicionariolancamento;